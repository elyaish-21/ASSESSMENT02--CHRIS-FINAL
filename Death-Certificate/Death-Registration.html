<!DOCTYPE html>
<html>
<head>
    <title>Death Certificate Registration</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.cdnfonts.com/css/golos-text" rel="stylesheet" />
    <link rel="icon" href="/images/cris_logo.png" type="image/x-icon">

    <style>
        body {
           margin: 0;
            padding: 0;
            font-family: 'Golos Text', sans-serif;
            background:
                url('death-bg-new.png') no-repeat bottom left fixed,
                url('d-bird-bg.png') no-repeat top right fixed;
          background-size: 500px auto, 300px auto; /* size for each image */
          background-color: #f8f7f2;
          min-height: 100vh;
          background-attachment: fixed;
          display: flex;
          justify-content: center;
          align-items: center;
        }

        section {
            padding: 10px;
        }

        .deceased-name, .DateAndTime, .Disposition {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .Cremation-DateAndTime, .Parents, .SexAndBirth {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        .death-registration {
            max-width: 700px;
            margin: 10px auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .death-registration h1 {
            text-align: center;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 25px;
        }

        .death-registration h2, h3{
            text-align: center;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 25px;
        }

        .fees {
            text-align: left;
            color: #333;
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            color: #555;
        }

       input[type="text"],
input[type="date"],
input[type="time"],
input[type="file"],
input[type="email"],
input[type="number"],
input[type="tel"],
select {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-sizing: border-box;
    font-size: 12px; /* Added consistent font size */
}

        input[type="radio"] {
            margin-right: 5px;
            margin-left: 10px;
        }

        input:focus::placeholder {
            color: transparent;
        }

        .form canvas {
            display: block;
            margin-top: 10px;
            margin-bottom: 20px;
            background-color: #fff;
            border: 1px solid #ccc;
        }

        .submit {
            margin-top: 20px;
            padding: 12px 25px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            display: block;
            width: 100%;
        }

        .submit:hover {
            background-color: #0056b3;
        }

        .success-message {
            margin-top: 20px;
            padding: 15px;
            display: none;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            background-color: #d4edda;
            color: #155724;
            text-align: center;
        }

        .clear {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
            margin-top: 5px;
            background-color: #007bff;
            border-radius: 4px;
            color: white;
            border: none;
            cursor: pointer;
        }

        .clear:hover {
            background-color: #0056b3;
        }

        .requirements {
            margin-bottom: 40px;
            background-color: #f0f4f8;
            padding: 20px;
            border-radius: 10px;
        }

        .requirements ul {
        margin-left: 20px;
        }

        .requirements ul li {
        margin-bottom: 8px;
        }

        .message {
            margin-top: 20px;
            padding: 12px;
            background-color: #dff0d8;
            color: #3c763d;
            text-align: center;
            border-radius: 8px;
            display: none;
            font-size: 1rem;
        } 
            
        .back-button {
        display: inline-block;
        margin: 20px 0 20px 10px; /* Push to left */
        text-align: center;
        padding: 10px 15px;
        background-color: #f70707;
        text-decoration: none;
        color: #e9e3e3;
        border-radius: 5px;
        font-weight: bold;
        }

        .back-button:hover {
        background-color: #f10707;
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Residence Section Styles */
       /* Residence Section Styles */
.residence-group {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 25px;
    font-size: 12px; /* Added base font size */
}

.residence-group input,
.residence-group select {
    width: 100%;
    padding: 10px;
    margin-top: 5px;
    border: 1px solid #d1d5db;
    border-radius: 5px;
    font-size: 12px; /* Ensured 12px font */
    background-color: white;
    transition: border-color 0.3s ease;
}

.residence-group label {
    display: block;
    font-size: 12px; /* Set label to 12px */
    margin-bottom: 8px;
    font-weight: bold;
    color: #555;
}
        .residence-group input:focus,
        .residence-group select:focus {
            border-color: #3b82f6;
                        font-size: 12px;

            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .residence-group input[readonly],
        .residence-group select:disabled {
            background-color: #f9fafb;
            color: #4b5563;
                        font-size: 12px;

            cursor: not-allowed;
            border-color: #e5e7eb;
        }

        .residence-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 1rem;
        }

        .error-message {
            color: #ef4444;
            font-size: 0.85rem;
            margin-top: 6px;
            display: none;
        }

        /* Make the location field span full width */
        .residence-group .full-width {
                        font-size: 12px;

            grid-column: span 3;
        }

        /* Feedback Styles */
        #feedbackPrompt {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.4);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        #feedbackPrompt > div {
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            width: 90%;
            max-width: 500px;
        }

        #feedbackPrompt span {
            position: absolute;
            top: 10px; right: 15px;
            font-size: 20px;
            cursor: pointer;
        }

        #starContainer {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        #starContainer .star {
            font-size: 2.5rem;
            color: #ccc;
            cursor: pointer;
            margin: 0 5px;
            transition: color 0.2s;
        }

        #starContainer .star.highlighted,
        #starContainer .star.selected {
            color: #ed2224;
        }

        #writtenFeedback {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.4);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }

        #writtenFeedback > div {
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            text-align: center;
            position: relative;
            width: 90%;
            max-width: 500px;
        }

        #writtenFeedback span {
            position: absolute;
            top: 10px; right: 15px;
            font-size: 20px;
            cursor: pointer;
        }

        #starsSelected {
            font-size: 2rem;
            color: #ed2224;
            margin-bottom: 15px;
        }

        #feedbackText {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            margin-top: 15px;
            min-height: 100px;
        }

        #thankYouFeedback {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.4);
            z-index: 10002;
            align-items: center;
            justify-content: center;
        }

        #thankYouFeedback > div {
            background: white;
            padding: 30px 40px;
            border-radius: 12px;
            text-align: center;
            width: 90%;
            max-width: 500px;
        }
    </style>
</head>
<body>
    <section>
        <div class="death-registration">
            <a class="back-button" href="Death-service.html">Back</a>
            <h1>Death Certificate Registration</h1>
            <hr>
            <div class="form">
                <form id="deathForm">
                    <h3>Deceased Personal Information</h3>
                    <div class="deceased-name">
                        <div class="last">
                            <label for="lastname">Last Name:</label>
                            <input type="text" id="lastName" placeholder="Last Name" required>
                        </div>                        
                        <div class="first">
                            <label for="firstname">First Name:</label>
                            <input type="text" id="firstName" placeholder="First Name" required>
                        </div>
                        <div class="middle">
                            <label for="middlename">Middle Name:</label>
                            <input type="text" id="middleName" placeholder="Middle Name">
                        </div>
                    </div>

                    <div class="SexAndBirth">
                        <div class="Sex">
                            <label for="sex">Sex</label>
                            <select id="sex" required>
                                <option value="">Select</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div class="Birth">
                            <label for="birthDate">Date of Birth</label>
                            <input type="date" id="birthDate" required>                
                        </div>
                    </div>

                    <div class="DateAndTime">
                        <div class="DeathDate">
                            <label for="deathDate">Date of Death</label>
                            <input type="date" id="deathDate" required>
                        </div>
                        <div class="DeathTime">
                            <label for="time">Time of Death</label>
                            <input type="time" id="time" required>
                        </div>
                        <div class="PlaceDate">
                            <label for="placeOfDeath">Place of Death</label>
                            <input type="text" id="placeOfDeath" placeholder="e.g. Home, Hospital - Full Address" required>
                        </div>
                    </div>

                    <label for="religion">Religion</label>
                    <input type="text" id="religion" placeholder="Religion" required>

                    <label for="citizenship">Citizenship</label>
                    <input type="text" id="citizenship" placeholder="Citizenship" required>

                    <label>Civil Status</label><br>
                    <input type="radio" name="civilStatus" value="single" required>Single
                    <input type="radio" name="civilStatus" value="married">Married
                    <input type="radio" name="civilStatus" value="widow">Widow

                    <label for="occupation">Occupation</label>
                    <input type="text" id="occupation" placeholder="Occupation" required>

                    <div class="Parents">
                        <div class="Father">
                            <label for="FatherName">Name of Father</label>
                            <input type="text" id="FatherName" placeholder="Last Name, First Name, Middle Name" required>
                        </div>
                        <div class="Mother">
                            <label for="MotherName">Name of Mother</label>
                            <input type="text" id="MotherName" placeholder="Last Name, First Name, Middle Name" required>
                        </div>
                    </div>

                    <h3>Residence Information</h3>
                    <div class="residence-group">
                        <!-- Region (fixed as NCR) -->
                        <div>
                            <label for="residenceRegion">Region</label>
                            <input type="text" id="residenceRegion" value="National Capital Region (NCR)" readonly required>
                        </div>
                        
                        <!-- City/Municipality (fixed as City of Manila) -->
                        <div>
                            <label for="residenceCity">City/Municipality</label>
                            <input type="text" id="residenceCity" value="City of Manila" readonly required>
                        </div>
                        
                        <!-- District Dropdown -->
                        <div>
                            <label for="residenceDistrict">District</label>
                            <select id="residenceDistrict" required onchange="updateResidenceBarangays()">
                                <option value="" disabled selected>Select District</option>
                                <option value="District I">District I</option>
                                <option value="District II">District II</option>
                                <option value="District III">District III</option>
                                <option value="District IV">District IV</option>
                                <option value="District V">District V</option>
                                <option value="District VI">District VI</option>
                            </select>
                            <div id="residence-district-error" class="error-message">Please select a district</div>
                        </div>
                        
                        <!-- Barangay Dropdown -->
                        <div>
                            <label for="residenceBarangay">Barangay</label>
                            <select id="residenceBarangay" required>
                                <option value="" disabled selected>Select Barangay</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                            <div id="residence-barangay-error" class="error-message">Please select a barangay</div>
                        </div>
                        
                        <!-- Specific Location -->
                        <div class="full-width">
                            <label for="residenceStreet">Street Name, House No.</label>
                            <input type="text" id="residenceStreet" placeholder="Street Name, House No." required>
                            <div id="residence-street-error" class="error-message">Please specify street address</div>
                        </div>
                    </div>

                    <label for="Cause">Cause of Death</label>
                    <input type="text" id="Cause" placeholder="Cause of Death" required>

                    <label for="external">Death by External Causes</label>
                    <input type="text" id="external" placeholder="Death by External Causes">

                    <label for="autopsy">Autopsy Report Received?</label><br>
                    <input type="radio" name="autopsy" value="yes" required>Yes
                    <input type="radio" name="autopsy" value="no">No         
                    
                    <hr>

                    <h3>Type of Disposition</h3>
                    <label for="disposition">Type of Disposition</label>
                    <select id="disposition" required>
                        <option value="">Select</option>
                        <option value="burial">Burial</option>
                        <option value="cremation">Cremation</option>
                    </select>
                    <label for="dispositionPlace">Place of Burial/Cremation</label>
                    <input type="text" id="dispositionPlace" placeholder="Cemetery/Crematorium Name & Address" required>
                    <label for="dispositionDate">Date of Burial/Cremation</label>
                    <input type="date" id="dispositionDate" required>

                    <hr>

                    <h3>Physician</h3>
                    <label for="physicianName">Certifying Physician's Name</label>
                    <input type="text" id="physicianName" placeholder="Full Name" required>

                    <label for="licenseNumber">License Number</label>
                    <input type="text" id="licenseNumber" placeholder="License Number" required>

                    <hr>

                    <h3>Informat Details</h3>
                    <label for="informantName">Informant's Name</label>
                    <input type="text" id="informantName" placeholder="Last Name, First Name, Middle Name" required>

                    <label for="relationship">Relationship to Deceased</label>
                    <input type="text" id="relationship" placeholder="e.g. Son, Wife, Neighbor" required>

                    <label for="informantContact">Contact Number</label>
                    <input type="tel" id="informantContact" pattern="[0-9]{4}-[0-9]{3}-[0-9]{4}" placeholder="09XX-XXX-XXXX" required>
                    <div id="contact-error" class="error-message">Please enter a valid contact number (09XX-XXX-XXXX)</div>

                    <label for="informantEmail">Email Address</label>
                    <input type="email" id="informantEmail" placeholder="your@email.com" required>
                    <div id="email-error" class="error-message">Please enter a valid email address</div>

                    <label for="signature">Signature</label>
                    <canvas id="signature" width="300" height="100" style="border:1px solid #000"></canvas>

                    <button type="button" class="clear" onclick="clearCanvas('signature')">Clear</button>
                    <hr>

                    <h3>Upload Requirement</h3>
                    <label>Upload Autopsy Report</label>
                    <input type="file" accept="image/*,application/pdf">

                    <label>Upload Valid Id of The Deceased</label>
                    <input type="file" accept="image/*,application/pdf">

                    <label>Upload Valid Id of The Requester</label>
                    <input type="file" accept="image/*,application/pdf">  

                    <label style="margin-top: 20px;">
                      <input type="checkbox" required> I certify that the information provided is true and correct.
                    </label>

                    <button type="button" class="submit" onclick="submitForm()">Submit</button>
                    <div id="success-message" class="success-message"></div>
                </form>
            </div>
        </div>
    </section>

    <!-- Feedback Prompt: Star Rating -->
    <div id="feedbackPrompt">
        <div>
            <span onclick="closeFeedback()">&times;</span>
            <h3>Would you like to leave feedback about your experience?</h3>
            <div id="starContainer"></div>
        </div>
    </div>

    <!-- Feedback Text Input -->
    <div id="writtenFeedback">
        <div>
            <span onclick="closeFeedback()">&times;</span>
            <div id="starsSelected">★★★★★</div>
            <p>Tell us a bit more about why you chose <span id="starCount">0</span> stars</p>
            <textarea id="feedbackText" rows="4" placeholder="e.g., fast and easy to understand"></textarea>
            <br /><br />
            <button onclick="submitFeedback()" style="background-color: #ed2224; color: white; padding: 10px 20px; border-radius: 8px; border: none;">Submit</button>
        </div>
    </div>

    <!-- Thank You Prompt -->
    <div id="thankYouFeedback">
        <div>
            <h3>Thank you for your feedback.</h3>
            <p>Your feedback is highly valued and is used to improve our service.</p>
            <button onclick="closeFeedback(); document.getElementById('deathForm').reset();" style="background-color: #254c9a; color: white; padding: 10px 20px; border-radius: 8px; border: none;">Done</button>
        </div>
    </div>

    <div class="gtranslate_wrapper"></div>
    <script>
    window.gtranslateSettings = {
        "default_language":"en",
        "wrapper_selector":".gtranslate_wrapper",
        "switcher_horizontal_position":"right",
        "switcher_vertical_position":"bottom",
        "flag_style":"3d"
    }
    </script>
    <script src="https://cdn.gtranslate.net/widgets/latest/float.js" defer></script>

    <script>
        // Barangay data by district
        const barangaysByDistrict = {
            "District I": ["Binondo", "Quiapo", "San Nicolas", "Santa Cruz", "Tondo I", "Tondo II"],
            "District II": ["Ermita", "Intramuros", "Malate", "Paco", "Pandacan", "Port Area", "San Miguel", "San Andres"],
            "District III": ["Santa Ana", "Santa Mesa"],
            "District IV": ["Sampaloc East", "Sampaloc West", "San Isidro", "San Jose", "San Juan", "San Rafael", "Santa Mesa", "Santo Cristo", "Santo Domingo", "Talayan"],
            "District V": ["Pandacan", "San Andres Bukid", "Santa Ana"],
            "District VI": ["Paco", "San Andres Bukid", "Santa Ana"]
        };

        function updateResidenceBarangays() {
            const districtSelect = document.getElementById("residenceDistrict");
            const barangaySelect = document.getElementById("residenceBarangay");
            const selectedDistrict = districtSelect.value;
            
            // Clear existing options
            barangaySelect.innerHTML = '<option value="" disabled selected>Select Barangay</option>';
            
            // Add new options based on selected district
            if (selectedDistrict && barangaysByDistrict[selectedDistrict]) {
                barangaysByDistrict[selectedDistrict].forEach(barangay => {
                    const option = document.createElement("option");
                    option.value = barangay;
                    option.textContent = barangay;
                    barangaySelect.appendChild(option);
                });
            }
        }

        function clearCanvas(id) {
            const canvas = document.getElementById(id);
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function clearAllFields() {
            document.getElementById("deathForm").reset();
            clearCanvas('signature');
            document.getElementById("residenceDistrict").selectedIndex = 0;
            document.getElementById("residenceBarangay").innerHTML = '<option value="" disabled selected>Select Barangay</option>';
            
            // Remove any error highlights
            document.querySelectorAll('[required]').forEach(el => {
                el.style.borderColor = '#ccc';
            });
        }

        function isCanvasEmpty(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext("2d");
            const pixelBuffer = new Uint32Array(
                ctx.getImageData(0, 0, canvas.width, canvas.height).data.buffer
            );
            return !pixelBuffer.some(color => color !== 0);
        }

        function generateRegistryNumber() {
            const now = new Date();
            return `REG-${now.getFullYear()}${(now.getMonth() + 1)
                .toString()
                .padStart(2, "0")}${now.getDate().toString().padStart(2, "0")}-${now
                .getTime()
                .toString()
                .slice(-5)}`;
        }

        function sendToDashboard() {
            const fullName = document.getElementById('informantName').value;
            const requestType = "Death Certificate Registration";
            const registryNumber = generateRegistryNumber();
            const dateRegistered = new Date().toLocaleDateString();
        
            const record = {
                name: fullName,
                type: requestType,
                regNo: registryNumber,
                dateRegistered: dateRegistered,
            };
        
            // Save to localStorage (or send via API)
            const records = JSON.parse(localStorage.getItem("DeathRecords")) || [];
            records.push(record);
            localStorage.setItem("DeathRecords", JSON.stringify(records));
        }

        function validateForm() {
            let isValid = true;
            
            // Validate contact number
            const contactPattern = /^09\d{2}-\d{3}-\d{4}$/;
            const contactInput = document.getElementById('informantContact');
            const contactError = document.getElementById('contact-error');
            
            if (!contactPattern.test(contactInput.value)) {
                contactError.style.display = 'block';
                isValid = false;
            } else {
                contactError.style.display = 'none';
            }
            
            // Validate email
            const emailInput = document.getElementById('informantEmail');
            const emailError = document.getElementById('email-error');
            
            if (!emailInput.validity.valid) {
                emailError.style.display = 'block';
                isValid = false;
            } else {
                emailError.style.display = 'none';
            }
            
            return isValid;
        }

        function generateCertificate() {
            try {
                // Check if jsPDF is available
                if (!window.jspdf) {
                    throw new Error('PDF library not loaded');
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const registryNumber = generateRegistryNumber();
                const firstName = document.getElementById("firstName").value;
                const middleName = document.getElementById("middleName").value;
                const lastName = document.getElementById("lastName").value;
                const sex = document.getElementById("sex").value;
                const birthDate = document.getElementById("birthDate").value;
                const deathDate = document.getElementById("deathDate").value;
                const time = document.getElementById("time").value;
                const placeOfDeath = document.getElementById("placeOfDeath").value;
                
                const residenceDistrict = document.getElementById("residenceDistrict").value;
                const residenceBarangay = document.getElementById("residenceBarangay").value;
                const residenceStreet = document.getElementById("residenceStreet").value;
                const residence = `${residenceStreet}, ${residenceBarangay}, ${residenceDistrict}, City of Manila, NCR`;
                
                const religion = document.getElementById("religion").value;
                const citizenship = document.getElementById("citizenship").value;
                const occupation = document.getElementById("occupation").value;
                const fatherName = document.getElementById("FatherName").value;
                const motherName = document.getElementById("MotherName").value;
                const cause = document.getElementById("Cause").value;
                const external = document.getElementById("external").value;
                const physicianName = document.getElementById("physicianName").value;
                const licenseNumber = document.getElementById("licenseNumber").value;
                const disposition = document.getElementById("disposition").value;
                const dispositionPlace = document.getElementById("dispositionPlace").value;
                const dispositionDate = document.getElementById("dispositionDate").value;

                doc.setDrawColor(0);
                doc.setLineWidth(1);
                doc.rect(10, 10, 190, 277);

                // Registry number
                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("Registry No.:", 130, 17);
                doc.setFont("helvetica", "normal");
                doc.text(registryNumber, 160, 17);

                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text("Republic of the Philippines", 105, 30, { align: "center" });

                doc.setFontSize(12);
                doc.text("City of Manila", 105, 38, { align: "center" });
                doc.text("Office of the Civil Registrar", 105, 46, { align: "center" });
                doc.text("National Capital Region (NCR)", 105, 54, { align: "center" });

                doc.setFontSize(18);
                doc.text("CERTIFICATE OF DEATH", 105, 70, { align: "center" });

                doc.setFont("helvetica", "normal");
                doc.setFontSize(12);

                const leftX = 20;
                const rightX = 110;
                let yLeft = 85;
                let yRight = 85;
                const lineHeight = 8;

                function addLine(label, value, isRight = false) {
                    const x = isRight ? rightX : leftX;
                    const y = isRight ? yRight : yLeft;
                    doc.text(`${label}:`, x, y);
                    doc.text(`${value}`, x + 45, y);
                    if (isRight) yRight += lineHeight;
                    else yLeft += lineHeight;
                }

                addLine("Full Name", `${firstName} ${middleName} ${lastName}`);
                addLine("Sex", sex);
                addLine("Date of Birth", birthDate);
                addLine("Date of Death", deathDate);
                addLine("Time of Death", time);
                addLine("Place of Death", placeOfDeath);
                addLine("Religion", religion);
                addLine("Citizenship", citizenship);
                addLine("Residence", residence);

                addLine("Occupation", occupation, true);
                addLine("Father's Name", fatherName, true);
                addLine("Mother's Name", motherName, true);
                addLine("Cause of Death", cause, true);
                addLine("External Cause", external, true);

                // Normalize Y for next section
                yLeft = Math.max(yLeft, yRight) + 10;
                yRight = yLeft;

                doc.setFont("helvetica", "bold");
                doc.text("Physician Information", leftX, yLeft);
                yLeft += lineHeight;
                doc.setFont("helvetica", "normal");
                addLine("Physician's Name", physicianName);
                addLine("License Number", licenseNumber);

                yLeft += 10;
                doc.setFont("helvetica", "bold");
                doc.text("Disposition Details", leftX, yLeft);
                yLeft += lineHeight;
                doc.setFont("helvetica", "normal");
                addLine("Type", disposition);
                addLine("Place", dispositionPlace);
                addLine("Date", dispositionDate);

                // Space for signature
                const maxY = 280; // keep content inside the 10mm margin at bottom
                let signatureY = yLeft + 20;
                const canvas = document.getElementById("signature");
                const imgData = canvas.toDataURL("image/png");
                const imgWidth = 60;
                const imgHeight = (canvas.height / canvas.width) * imgWidth;

                // Adjust if the signature area goes beyond the bottom border
                if (signatureY + imgHeight + 16 > maxY) {
                    signatureY = maxY - imgHeight - 16; // move it up to fit
                }

                // Add image and label
                doc.addImage(imgData, "PNG", rightX, signatureY, imgWidth, imgHeight);
                doc.text("_________________________", rightX, signatureY + imgHeight + 4);
                doc.text("Signature of Informant", rightX, signatureY + imgHeight + 10);

                const fileName = `Death_Certificate_${registryNumber}.pdf`;
                doc.save(fileName);

                // Send to dashboard
                sendToDashboard();

                // Show success message and feedback prompt
                Swal.fire({
                    title: 'Success!',
                    text: 'Death certificate has been generated and downloaded.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then(() => {
                    showFeedbackPrompt();
                });

                return true;

           } catch (error) {
                console.error("Error generating PDF:", error);
                alert("Failed to generate PDF. Please try again.");
                return false;
            }
        }

        function initSignatureCanvas() {
            const canvas = document.getElementById("signature");
            const ctx = canvas.getContext("2d");
            let drawing = false;
            
            // Set proper canvas dimensions
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            
            // Set white background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Set drawing styles
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            // Event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            function startDrawing(e) {
                drawing = true;
                draw(e);
            }
            
            function draw(e) {
                if (!drawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                ctx.lineTo(x, y);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(x, y);
            }
            
            function stopDrawing() {
                drawing = false;
                ctx.beginPath();
            }
        }

        // Initialize feedback system
        function initFeedbackSystem() {
            const starContainer = document.getElementById("starContainer");
            let selectedRating = 0;

            // Clear container first
            starContainer.innerHTML = '';

            // Create 5 stars
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.innerHTML = '★';
                star.dataset.rating = i;
                
                star.addEventListener('click', function() {
                    selectedRating = i;
                    highlightStars(selectedRating);
                    showWrittenFeedback(selectedRating);
                });

                star.addEventListener('mouseover', function() {
                    highlightStars(i);
                });

                star.addEventListener('mouseout', function() {
                    highlightStars(selectedRating);
                });

                starContainer.appendChild(star);
            }

            function highlightStars(rating) {
                const stars = document.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    star.classList.remove('highlighted', 'selected');
                    
                    if (index < rating) {
                        star.classList.add('highlighted');
                    }
                    
                    if (index < selectedRating) {
                        star.classList.add('selected');
                    }
                });
            }

            window.showWrittenFeedback = function(rating) {
                document.getElementById("feedbackPrompt").style.display = "none";
                document.getElementById("writtenFeedback").style.display = "flex";
                document.getElementById("starCount").textContent = rating;
                document.getElementById("starsSelected").innerHTML = "★".repeat(rating) + "☆".repeat(5 - rating);
            };

            window.closeFeedback = function() {
                document.getElementById("feedbackPrompt").style.display = "none";
                document.getElementById("writtenFeedback").style.display = "none";
                document.getElementById("thankYouFeedback").style.display = "none";
            };

            window.showFeedbackPrompt = function() {
                document.getElementById("feedbackPrompt").style.display = "flex";
            };

            window.submitFeedback = function() {
                const feedback = document.getElementById("feedbackText").value.trim();
                if (feedback) {
                    // Here you would typically send the feedback to your server
                    console.log("Feedback submitted:", {
                        rating: selectedRating,
                        comments: feedback
                    });
                    
                    document.getElementById("writtenFeedback").style.display = "none";
                    document.getElementById("thankYouFeedback").style.display = "flex";
                    
                    // Clear feedback text for next time
                    document.getElementById("feedbackText").value = "";
                    selectedRating = 0;
                    highlightStars(0);
                } else {
                    alert("Please enter your feedback.");
                }
            };
        }

        // Main form submission function with confirmation
        function submitForm() {
            // Validate all required fields
            const requiredInputs = document.querySelectorAll('[required]');
            let isValid = true;

            for (const input of requiredInputs) {
                if (!input.value) {
                    input.style.borderColor = 'red';
                    isValid = false;
                } else {
                    input.style.borderColor = '#ccc';
                }
            }

            if (!isValid) {
                alert("Please fill out all required fields.");
                return;
            }

            // Validate signature
            if (isCanvasEmpty("signature")) {
                alert("Please provide a signature.");
                return;
            }

            // Validate contact and email
            if (!validateForm()) {
                return;
            }

            // Show fancy confirmation dialog
            Swal.fire({
                title: 'Confirm Submission',
                text: 'Are you sure you want to submit the form? A PDF certificate will be downloaded automatically.',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, submit!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    generateCertificate();
                }
            });
        }

        window.onload = () => {
            // Initialize signature canvas
            initSignatureCanvas();
            
            // Initialize feedback system
            initFeedbackSystem();
            
            // Set max dates for date inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById("birthDate").setAttribute('max', today);
            document.getElementById("deathDate").setAttribute('max', today);
            document.getElementById("dispositionDate").setAttribute('max', today);
            
            // Mobile number format
            const phoneInput = document.getElementById("informantContact");

            phoneInput.addEventListener("input", function () {
                let value = phoneInput.value.replace(/\D/g, ""); // Remove non-digit characters
                if (value.length > 4) {
                    value = value.slice(0, 4) + "-" + value.slice(4);
                }
                if (value.length > 8) {
                    value = value.slice(0, 8) + "-" + value.slice(8, 12);
                }
                phoneInput.value = value;
            });
        };
    </script>
</body>
</html>